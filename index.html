<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sukkiri Log - ä¹—ã‚Šç‰©é…”ã„äºˆé˜²ï¼†è¨˜éŒ²</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'M PLUS Rounded 1c', sans-serif;
            background-color: #F0FDFA; /* Teal-50 */
            color: #334155; /* Slate-700 */
        }
        /* Mobile-app like container */
        #app-container {
            max-width: 480px;
            margin: 0 auto;
            background-color: white;
            min-height: 100vh;
            box-shadow: 0 0 20px rgba(0,0,0,0.05);
            position: relative;
            padding-bottom: 90px; /* Space for bottom nav */
        }
        .slide-in {
            animation: slideIn 0.3s ease-out forwards;
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        /* Range Slider Styling */
        input[type=range] {
            -webkit-appearance: none;
            width: 100%;
            background: transparent;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 28px; /* Larger thumb */
            width: 28px;
            border-radius: 50%;
            background: #14B8A6;
            cursor: pointer;
            margin-top: -10px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
            border: 2px solid white;
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 8px;
            cursor: pointer;
            background: #CCFBF1;
            border-radius: 4px;
        }
        /* Big Record Button Pulse Animation */
        .pulse-btn {
            animation: pulse-soft 2s infinite;
        }
        @keyframes pulse-soft {
            0% { box-shadow: 0 0 0 0 rgba(20, 184, 166, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(20, 184, 166, 0); }
            100% { box-shadow: 0 0 0 0 rgba(20, 184, 166, 0); }
        }
        /* Hide Scrollbar but allow scroll */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
        /* Clickable Row Header Styles */
        .row-header-btn {
            transition: all 0.2s;
        }
        .row-header-btn:active {
            transform: scale(0.95);
            background-color: #f0fdf4;
        }
        .row-header-active {
            background-color: #e0f2fe !important; /* Blue-100 */
            color: #0284c7 !important; /* Sky-600 */
            border-right: 2px solid #0284c7;
        }
        /* Modal Animation */
        .modal-enter {
            animation: modalFadeIn 0.2s ease-out forwards;
        }
        @keyframes modalFadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
    </style>
</head>
<body>

<div id="app-container">
    <!-- Header -->
    <header class="bg-teal-500 text-white p-4 sticky top-0 z-10 shadow-md flex justify-between items-center h-14">
        <h1 class="text-lg font-bold"><i class="fa-solid fa-leaf mr-2"></i>Sukkiri Log</h1>
        <button onclick="resetData()" class="text-xs bg-teal-600 px-2 py-1 rounded hover:bg-teal-700">ãƒªã‚»ãƒƒãƒˆ</button>
    </header>

    <!-- Main Content Area -->
    <main id="content" class="p-4">
        <!-- Content injected via JS -->
    </main>

    <!-- Detail Modal (Hidden by default) -->
    <div id="detail-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black bg-opacity-50 p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden modal-enter relative">
            <!-- Modal Header -->
            <div class="bg-teal-500 p-4 text-white flex justify-between items-center">
                <h3 class="font-bold text-lg"><i class="fa-solid fa-circle-info mr-2"></i>è¨˜éŒ²è©³ç´°</h3>
                <button onclick="closeDetail()" class="text-white hover:bg-teal-600 w-8 h-8 rounded-full flex items-center justify-center">
                    <i class="fa-solid fa-xmark text-xl"></i>
                </button>
            </div>
            
            <!-- Modal Body -->
            <div class="p-6 space-y-4">
                <div class="flex justify-between items-end border-b border-gray-100 pb-2">
                    <div>
                        <p class="text-xs text-gray-400 font-bold mb-1">æ—¥æ™‚</p>
                        <p id="modal-date" class="text-gray-700 font-bold text-lg">--/-- --:--</p>
                    </div>
                    <div id="modal-weather" class="text-2xl text-gray-400"></div>
                </div>

                <div class="flex items-center gap-4 bg-gray-50 p-4 rounded-xl">
                    <div id="modal-emoji" class="text-4xl">ğŸ™‚</div>
                    <div>
                        <p class="text-xs text-gray-400 font-bold">ä½“èª¿ãƒ¬ãƒ™ãƒ«</p>
                        <p id="modal-sickness" class="text-2xl font-bold text-teal-600">Lv.--</p>
                    </div>
                </div>

                <div>
                    <p class="text-xs text-gray-400 font-bold mb-1">ãƒ¡ãƒ¢</p>
                    <div id="modal-note" class="bg-gray-50 p-3 rounded-lg text-sm text-gray-700 min-h-[60px]">
                        ãƒ¡ãƒ¢ã¯ã‚ã‚Šã¾ã›ã‚“
                    </div>
                </div>

                <!-- Video Section -->
                <div id="modal-video-section" class="hidden">
                    <p class="text-xs text-gray-400 font-bold mb-1">å‹•ç”»è¨˜éŒ²</p>
                    <div class="aspect-video bg-black rounded-lg flex items-center justify-center relative overflow-hidden group cursor-pointer">
                        <i class="fa-solid fa-play text-4xl text-white opacity-80 group-hover:scale-110 transition"></i>
                        <div class="absolute inset-0 bg-black bg-opacity-20"></div>
                        <!-- Mock Video Overlay -->
                        <p class="absolute bottom-2 right-3 text-white text-xs font-bold shadow-black drop-shadow-md">å†ç”Ÿ (ãƒ‡ãƒ¢)</p>
                    </div>
                </div>
            </div>
            
            <!-- Modal Footer -->
            <div class="bg-gray-50 p-4 text-center">
                <button onclick="closeDetail()" class="text-sm text-gray-500 font-bold hover:text-gray-700">é–‰ã˜ã‚‹</button>
            </div>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <nav class="fixed bottom-0 w-full max-w-[480px] bg-white border-t border-gray-200 flex justify-around py-3 text-xs text-gray-500 z-20 pb-6">
        <button onclick="navigateTo('home')" class="nav-btn flex flex-col items-center gap-1 text-teal-500 w-1/3" id="nav-home">
            <i class="fa-solid fa-house text-xl"></i>
            <span>ãƒ›ãƒ¼ãƒ </span>
        </button>
        <button onclick="navigateTo('record')" class="nav-btn flex flex-col items-center gap-1 hover:text-teal-500 w-1/3" id="nav-record">
            <div class="bg-teal-500 text-white rounded-full p-3 -mt-6 shadow-lg border-4 border-white">
                <i class="fa-solid fa-plus text-xl"></i>
            </div>
            <span class="mt-1 font-bold">è¨˜éŒ²</span>
        </button>
        <button onclick="navigateTo('history')" class="nav-btn flex flex-col items-center gap-1 hover:text-teal-500 w-1/3" id="nav-history">
            <i class="fa-solid fa-chart-line text-xl"></i>
            <span>æŒ¯ã‚Šè¿”ã‚Š</span>
        </button>
    </nav>
</div>

<script>
    // --- Mock Data & State ---
    let records = JSON.parse(localStorage.getItem('sukkiri_records_v3')) || [
        { id: 1, date: '2023-11-10 08:30', type: 'bus', sickness: 60, weather: 'rain', note: 'æ¹¿æ°—ãŒå¤šãã¦ç©ºæ°—ãŒé‡ã‹ã£ãŸã€‚', hasVideo: false },
        { id: 2, date: '2023-11-12 10:00', type: 'car', sickness: 10, weather: 'sunny', note: 'æ›æ°—ã‚’ã“ã¾ã‚ã«ã—ãŸã®ã§å¿«é©ã€‚', hasVideo: false },
        { id: 3, date: '2023-11-15 14:00', type: 'train', sickness: 5, weather: 'sunny', note: '', hasVideo: false },
        { id: 4, date: '2023-11-16 18:30', type: 'bus', sickness: 75, weather: 'cloudy', note: 'ä»•äº‹å¸°ã‚Šã§ç–²ã‚Œã¦ã„ãŸã›ã„ã‹ã‚‚ã€‚', hasVideo: false },
        { id: 5, date: '2023-11-20 09:00', type: 'ship', sickness: 95, weather: 'rain', note: 'æ³¢ãŒé«˜ãã¦ã™ãã«é™ç•ŒãŒããŸã€‚', hasVideo: true },
        { id: 6, date: '2023-11-21 11:00', type: 'car', sickness: 30, weather: 'cloudy', note: 'å°‘ã—æ°—æŒã¡æ‚ªã‹ã£ãŸãŒä¼‘æ†©ã§å›å¾©ã€‚', hasVideo: false },
        { id: 7, date: '2023-11-22 13:00', type: 'train', sickness: 15, weather: 'sunny', note: 'é ãã®å±±ã‚’è¦‹ã¦ã„ãŸã€‚', hasVideo: false },
        { id: 8, date: '2023-11-24 10:00', type: 'bus', sickness: 40, weather: 'rain', note: 'é›¨ã®åŒ‚ã„ãŒå°‘ã—æ°—ã«ãªã£ãŸã€‚', hasVideo: true },
        { id: 9, date: '2023-11-25 15:30', type: 'car', sickness: 10, weather: 'sunny', note: 'åŠ©æ‰‹å¸­ã ã£ãŸã®ã§å¤§ä¸ˆå¤«ã ã£ãŸã€‚', hasVideo: false },
        { id: 10, date: '2023-11-26 12:00', type: 'train', sickness: 20, weather: 'cloudy', note: '', hasVideo: false },
        { id: 11, date: '2023-11-28 09:00', type: 'ship', sickness: 80, weather: 'cloudy', note: 'é…”ã„æ­¢ã‚ã‚’é£²ã¿å¿˜ã‚ŒãŸã€‚', hasVideo: false },
        { id: 12, date: '2023-11-29 16:00', type: 'car', sickness: 5, weather: 'sunny', note: 'éŸ³æ¥½ã‚’è´ã„ã¦ãƒªãƒ©ãƒƒã‚¯ã‚¹ã§ããŸã€‚', hasVideo: false }
    ];

    let lastTransport = localStorage.getItem('sukkiri_last_transport') || 'car';

    let filterState = {
        category: null,
        value: null
    };

    // --- Navigation Logic ---
    function navigateTo(pageId) {
        document.querySelectorAll('.nav-btn').forEach(btn => {
            if(btn.id !== 'nav-record') { 
                btn.classList.remove('text-teal-500');
                btn.classList.add('text-gray-500');
            }
        });
        
        if(pageId !== 'record') {
             const activeBtn = document.getElementById(`nav-${pageId}`);
             if(activeBtn) {
                 activeBtn.classList.add('text-teal-500');
                 activeBtn.classList.remove('text-gray-500');
             }
        }

        const content = document.getElementById('content');
        content.innerHTML = ''; 

        if (pageId === 'home') renderHome(content);
        if (pageId === 'record') renderRecord(content);
        if (pageId === 'history') renderHistory(content);
        
        window.scrollTo(0,0);
    }

    // --- Page Renderers ---
    function renderHome(container) {
        const goodTrips = records.filter(r => r.sickness <= 30).length;
        container.innerHTML = `
            <div class="slide-in space-y-6 pt-2">
                <div class="bg-gradient-to-br from-teal-400 to-teal-600 rounded-3xl p-6 text-white shadow-lg text-center relative overflow-hidden">
                    <div class="absolute top-0 right-0 p-4 opacity-20"><i class="fa-solid fa-leaf text-6xl"></i></div>
                    <p class="text-sm opacity-90 mb-1">ç¾åœ¨ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</p>
                    <h2 class="text-3xl font-bold mb-2">è‡ªä¿¡ãŒã¤ã„ã¦ãã¾ã—ãŸï¼</h2>
                    <p class="text-sm">ã“ã‚Œã¾ã§ã®è¨˜éŒ²ã§ã€<span class="font-bold text-yellow-300 text-lg">${goodTrips}å›</span> å¿«é©ã«ç§»å‹•ã§ãã¦ã„ã¾ã™ã€‚</p>
                </div>
                
                <!-- Main Action: Big Record Button (Enhanced Visibility) -->
                <div class="text-center py-6">
                    <button onclick="navigateTo('record')" class="pulse-btn w-64 h-64 rounded-full bg-gradient-to-br from-teal-400 to-teal-600 border-4 border-white ring-4 ring-teal-100 shadow-2xl flex flex-col items-center justify-center mx-auto hover:from-teal-500 hover:to-teal-700 transition transform active:scale-95 group relative overflow-hidden">
                        <!-- Shine effect -->
                        <div class="absolute top-0 left-0 w-full h-full bg-white opacity-10 rounded-full scale-0 group-hover:scale-150 transition-transform duration-500"></div>
                        
                        <i class="fa-solid fa-pen-to-square text-6xl text-white mb-3 group-hover:scale-110 transition-transform drop-shadow-md"></i>
                        <span class="text-3xl font-bold text-white drop-shadow-md tracking-wider">è¨˜éŒ²ã™ã‚‹</span>
                        <span class="text-sm text-teal-50 mt-2 font-bold opacity-90">ä»Šã®æ°—åˆ†ãƒ»çŠ¶æ³ã‚’æ®‹ã™</span>
                    </button>
                    <p class="text-sm text-gray-500 mt-8 font-bold flex items-center justify-center gap-2">
                         <span class="inline-block w-2 h-2 rounded-full bg-teal-500 animate-ping"></span>
                         ã“ã¾ã‚ãªè¨˜éŒ²ãŒã€æœªæ¥ã®äºˆé˜²ã«ã¤ãªãŒã‚Šã¾ã™
                    </p>
                </div>

                <div class="bg-orange-50 rounded-xl p-4 flex items-start gap-3">
                    <i class="fa-solid fa-lightbulb text-orange-400 mt-1"></i>
                    <div class="text-sm text-gray-700">
                        <strong>ãƒ¯ãƒ³ãƒã‚¤ãƒ³ãƒˆ</strong><br>
                        é ãã®æ™¯è‰²ã‚’è¦‹ã‚‹ã¨ãã¯ã€é€²è¡Œæ–¹å‘ã‚’è¦‹ã‚‹ã‚ˆã†ã«ã—ã¾ã—ã‚‡ã†ã€‚
                    </div>
                </div>
            </div>
        `;
    }

    function renderRecord(container) {
        const now = new Date();
        const dateStr = now.toISOString().slice(0, 16); 
        container.innerHTML = `
            <div class="slide-in">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-bold text-gray-800">ä»Šã®çŠ¶æ³ã‚’è¨˜éŒ²</h2>
                    <span class="text-xs bg-gray-100 text-gray-500 px-2 py-1 rounded">è‡ªå‹•å…¥åŠ›ON</span>
                </div>
                <form id="recordForm" onsubmit="saveRecord(event)" class="space-y-6 bg-white p-6 rounded-2xl shadow-sm">
                    <div>
                        <label class="block text-sm font-bold text-gray-600 mb-1">æ—¥æ™‚</label>
                        <input type="datetime-local" id="input-date" value="${dateStr}" class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl font-bold text-gray-700">
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-600 mb-1">ç’°å¢ƒï¼ˆå¤©æ°—ãƒ»æ°—åœ§ï¼‰</label>
                        <div class="bg-blue-50 p-3 rounded-xl flex items-center justify-between border border-blue-100">
                            <div class="flex items-center gap-3">
                                <div id="weather-icon" class="w-10 h-10 rounded-full bg-white flex items-center justify-center text-blue-400 shadow-sm">
                                    <i class="fa-solid fa-spinner fa-spin"></i>
                                </div>
                                <div>
                                    <div id="weather-text" class="font-bold text-gray-700 text-sm">å–å¾—ä¸­...</div>
                                    <div id="weather-detail" class="text-xs text-gray-500">ä½ç½®æƒ…å ±ã‹ã‚‰è§£æä¸­</div>
                                </div>
                            </div>
                        </div>
                        <input type="hidden" id="input-weather" value="unknown">
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-600 mb-2">ä¹—ã‚Šç‰©ã®ç¨®é¡</label>
                        <div class="grid grid-cols-4 gap-2">
                            ${renderTransportOption('car', 'è»Š', lastTransport)}
                            ${renderTransportOption('bus', 'ãƒã‚¹', lastTransport)}
                            ${renderTransportOption('train', 'é›»è»Š', lastTransport)}
                            ${renderTransportOption('ship', 'èˆ¹', lastTransport)}
                        </div>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-xl">
                        <label class="block text-sm font-bold text-gray-600 mb-2">ä»Šã®æ°—åˆ†ã¯ï¼Ÿ (1ã€œ100)</label>
                        <div class="flex items-center justify-between mb-4 px-2">
                            <span class="text-4xl transition-transform" id="emoji-display">ğŸ™‚</span>
                            <span class="font-bold text-teal-600 text-3xl" id="level-display">1</span>
                        </div>
                        <input type="range" id="input-sickness" min="1" max="100" value="1" step="1" oninput="updateRangeDisplay(this.value)" class="h-2">
                        <div class="flex justify-between text-xs text-gray-400 mt-2 px-1">
                            <span>å¿«é©</span>
                            <span>å°‘ã—</span>
                            <span>æ‚ªã„</span>
                            <span>é™ç•Œ</span>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-600 mb-1">çŠ¶æ³ã‚’å‹•ç”»ã§è¨˜éŒ²</label>
                        <div id="video-upload-area" class="border-2 border-dashed border-gray-300 rounded-xl p-6 text-center hover:bg-gray-50 transition cursor-pointer relative" onclick="document.getElementById('input-video').click()">
                            <input type="file" id="input-video" accept="video/*" class="hidden" onchange="handleVideoPreview(this)">
                            <div id="video-placeholder">
                                <i class="fa-solid fa-video text-3xl text-gray-300 mb-2"></i>
                                <p class="text-xs text-gray-500 font-bold">5ç§’ç¨‹åº¦ã®å‹•ç”»ã‚’è¿½åŠ </p>
                                <p class="text-[10px] text-gray-400">ã‚¿ãƒƒãƒ—ã—ã¦æ’®å½±ã¾ãŸã¯é¸æŠ</p>
                            </div>
                            <div id="video-preview-container" class="hidden">
                                <video id="video-preview" controls class="w-full rounded-lg max-h-40 bg-black"></video>
                                <button type="button" onclick="event.stopPropagation(); clearVideo();" class="absolute top-2 right-2 bg-gray-800 bg-opacity-70 text-white rounded-full w-8 h-8 flex items-center justify-center hover:bg-red-500">
                                    <i class="fa-solid fa-xmark"></i>
                                </button>
                                <p class="text-[10px] text-green-600 mt-1 font-bold"><i class="fa-solid fa-check"></i> å‹•ç”»ãŒé¸æŠã•ã‚Œã¾ã—ãŸ</p>
                            </div>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-600 mb-1">ãƒ¡ãƒ¢</label>
                        <textarea id="input-note" rows="2" class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl text-sm" placeholder="æ°—ã«ãªã£ãŸã“ã¨"></textarea>
                    </div>
                    <button type="submit" class="w-full bg-teal-500 text-white font-bold py-4 rounded-xl shadow-lg hover:bg-teal-600 transform active:scale-95 transition text-lg flex justify-center items-center gap-2">
                        <i class="fa-solid fa-check"></i> ä¿å­˜ã™ã‚‹
                    </button>
                </form>
            </div>
        `;
        updateRangeDisplay(1);
        fetchWeatherMock(); 
    }

    function renderTransportOption(value, label, current) {
        const checked = value === current ? 'checked' : '';
        const iconMap = { car: 'fa-car', bus: 'fa-bus', train: 'fa-train', ship: 'fa-ship' };
        return `
            <label class="cursor-pointer">
                <input type="radio" name="transport" value="${value}" class="peer hidden" ${checked}>
                <div class="p-3 border-2 border-transparent bg-gray-100 rounded-xl text-center text-gray-400 peer-checked:bg-teal-500 peer-checked:text-white peer-checked:shadow-md transition duration-200">
                    <i class="fa-solid ${iconMap[value]} block text-xl mb-1"></i>
                    <span class="text-xs font-bold">${label}</span>
                </div>
            </label>
        `;
    }

    function renderHistory(container) {
        let displayRecords = [...records].sort((a, b) => new Date(a.date) - new Date(b.date));
        
        if (filterState.category && filterState.value) {
            displayRecords = displayRecords.filter(r => {
                if (filterState.category === 'weather') return r.weather === filterState.value;
                if (filterState.category === 'transport') return r.type === filterState.value;
                return true;
            });
        }

        const isWeatherActive = filterState.category === 'weather' ? 'row-header-active' : '';
        const isTransportActive = filterState.category === 'transport' ? 'row-header-active' : '';

        let filterMenuHtml = '';
        if (filterState.category) {
            const options = filterState.category === 'weather' 
                ? [
                    {val: 'sunny', label: 'æ™´ã‚Œ', icon: 'fa-sun'},
                    {val: 'rain', label: 'é›¨', icon: 'fa-cloud-rain'},
                    {val: 'cloudy', label: 'æ›‡ã‚Š', icon: 'fa-cloud'}
                  ]
                : [
                    {val: 'car', label: 'è»Š', icon: 'fa-car'},
                    {val: 'bus', label: 'ãƒã‚¹', icon: 'fa-bus'},
                    {val: 'train', label: 'é›»è»Š', icon: 'fa-train'},
                    {val: 'ship', label: 'èˆ¹', icon: 'fa-ship'}
                  ];
            
            const buttons = options.map(opt => {
                const isActive = filterState.value === opt.val ? 'bg-teal-500 text-white border-teal-500' : 'bg-white text-gray-600 border-gray-200 hover:bg-gray-50';
                return `<button onclick="setFilterValue('${opt.val}')" class="px-3 py-1.5 rounded-full border text-xs font-bold flex items-center gap-1 transition ${isActive}">
                            <i class="fa-solid ${opt.icon}"></i> ${opt.label}
                        </button>`;
            }).join('');

            filterMenuHtml = `
                <div class="mb-4 bg-gray-50 p-3 rounded-xl border border-gray-100 animate-fade-in-down">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-xs font-bold text-gray-500">
                            ${filterState.category === 'weather' ? 'å¤©æ°—' : 'ä¹—ã‚Šç‰©'}ã§çµã‚Šè¾¼ã¿ä¸­
                        </span>
                        <button onclick="clearFilter()" class="text-xs text-blue-500 font-bold hover:underline">
                            <i class="fa-solid fa-xmark"></i> è§£é™¤
                        </button>
                    </div>
                    <div class="flex flex-wrap gap-2">
                        ${buttons}
                    </div>
                </div>
            `;
        } else {
             filterMenuHtml = `
                <div class="bg-indigo-50 border border-indigo-100 p-4 rounded-xl mb-4 flex gap-3 items-center">
                    <i class="fa-solid fa-filter text-indigo-400"></i>
                    <p class="text-xs text-indigo-800">
                        å·¦å´ã®ã€Œå¤©æ°—ã€ã‚„ã€Œä¹—ã‚Šç‰©ã€ã‚¢ã‚¤ã‚³ãƒ³ã‚’ã‚¿ãƒƒãƒ—ã™ã‚‹ã¨<br>
                        ã‚°ãƒ©ãƒ•ã‚’çµã‚Šè¾¼ã‚“ã§è¡¨ç¤ºã§ãã¾ã™ã€‚
                    </p>
                </div>
            `;
        }

        let chartItems = '';
        if(displayRecords.length === 0) {
            chartItems = `<div class="p-6 text-gray-400 text-sm whitespace-nowrap">è©²å½“ã™ã‚‹è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</div>`;
        } else {
            displayRecords.forEach(rec => {
                const dateObj = new Date(rec.date);
                const dateDisplay = `${dateObj.getMonth()+1}/${dateObj.getDate()}`;
                const timeDisplay = `${dateObj.getHours()}:${String(dateObj.getMinutes()).padStart(2, '0')}`;
                
                const weatherData = {
                    sunny: { icon: 'fa-sun', color: 'text-orange-400' },
                    rain: { icon: 'fa-cloud-rain', color: 'text-blue-500' },
                    cloudy: { icon: 'fa-cloud', color: 'text-gray-400' },
                    unknown: { icon: 'fa-question', color: 'text-gray-300' }
                };
                const w = weatherData[rec.weather] || weatherData.unknown;
                const iconMap = { car: 'fa-car', bus: 'fa-bus', train: 'fa-train', ship: 'fa-ship' };
                const heightPercent = rec.sickness; 
                let barColor = "bg-teal-300";
                if(rec.sickness >= 40) barColor = "bg-yellow-300";
                if(rec.sickness >= 60) barColor = "bg-orange-400";
                if(rec.sickness >= 80) barColor = "bg-red-500";

                const videoIndicator = rec.hasVideo 
                    ? `<div class="absolute -bottom-3 left-1/2 -translate-x-1/2 w-5 h-5 bg-gray-800 rounded-full flex items-center justify-center border-2 border-white shadow-md z-10"><i class="fa-solid fa-play text-[8px] text-white ml-0.5"></i></div>` 
                    : '';
                
                const noteIndicator = rec.note
                    ? `<div class="absolute -top-3 left-1/2 -translate-x-1/2 text-indigo-400 drop-shadow-sm"><i class="fa-solid fa-comment-dots text-lg"></i></div>`
                    : '';

                const clickHandler = `showDetail(${rec.id})`;

                // Enhanced Item UI
                chartItems += `
                    <div class="flex flex-col items-center min-w-[76px] group relative border-r border-gray-100 last:border-0 hover:bg-gray-50 transition-colors">
                        <!-- Graph Bar Area (Height Fixed: 160px) -->
                        <div class="h-[160px] w-full flex items-end justify-center pb-3 border-b border-gray-200 relative bg-white">
                            <!-- Background Grid Lines -->
                            <div class="absolute inset-0 flex flex-col justify-between pointer-events-none opacity-30 pb-3">
                                <div class="border-t border-dashed border-gray-300 w-full h-0 mt-[0%]"></div>
                                <div class="border-t border-dashed border-gray-300 w-full h-0 mt-[25%]"></div>
                                <div class="border-t border-dashed border-gray-300 w-full h-0 mt-[50%]"></div>
                                <div class="border-t border-dashed border-gray-300 w-full h-0 mt-[75%]"></div>
                            </div>

                            <!-- Bar -->
                            <div class="${barColor} w-6 rounded-t-lg relative transition-all group-hover:scale-105 group-hover:brightness-95 cursor-pointer shadow-sm z-10" 
                                style="height: ${heightPercent}%;"
                                onclick="${clickHandler}">
                                ${noteIndicator}
                                ${videoIndicator}
                            </div>
                        </div>
                        
                        <!-- Level Number (Height Fixed: h-6 / 24px) -->
                        <div class="h-6 w-full flex items-center justify-center text-xs font-bold text-gray-500 bg-white border-b border-gray-100">${rec.sickness}</div>

                        <!-- Weather Lane (Height Fixed: h-11 / 44px) -->
                        <div class="h-11 w-full flex items-center justify-center border-b border-gray-100 bg-blue-50/40">
                            <i class="fa-solid ${w.icon} ${w.color} text-xl drop-shadow-sm"></i>
                        </div>

                        <!-- Transport Lane (Height Fixed: h-11 / 44px) -->
                        <div class="h-11 w-full flex items-center justify-center border-b border-gray-100 bg-white">
                            <i class="fa-solid ${iconMap[rec.type]} text-gray-500 text-lg"></i>
                        </div>

                        <!-- Date Lane (Height Fixed: h-10 / 40px) -->
                        <div class="h-10 w-full flex flex-col justify-center items-center bg-gray-50 rounded-b-lg">
                            <div class="text-[10px] font-bold text-gray-500 leading-tight">${dateDisplay}</div>
                            <div class="text-[9px] text-gray-400 leading-tight">${timeDisplay}</div>
                        </div>
                    </div>
                `;
            });
        }

        container.innerHTML = `
            <div class="slide-in pb-20">
                
                <!-- AI Analysis Button -->
                <div class="mb-4 text-center">
                    <button onclick="analyzeRecordsWithGemini()" class="w-full bg-gradient-to-r from-indigo-500 to-purple-500 text-white font-bold py-3 rounded-2xl shadow-lg hover:shadow-xl transform transition active:scale-95 flex items-center justify-center gap-2">
                        <i class="fa-solid fa-wand-magic-sparkles text-yellow-300"></i>
                        AIã§å‚¾å‘ã¨å¯¾ç­–ã‚’åˆ†æ
                    </button>
                    <p class="text-[10px] text-gray-400 mt-2">Gemini AIãŒã‚ãªãŸã®è¨˜éŒ²ã‚’åˆ†æã—ã¾ã™</p>
                </div>

                <h2 class="text-lg font-bold text-gray-700 mb-3 px-1">å‚¾å‘ã‚’ãƒã‚§ãƒƒã‚¯</h2>
                ${filterMenuHtml}
                
                <!-- Enhanced Swimlane Chart Container -->
                <div class="bg-white rounded-2xl shadow-md border border-gray-200 overflow-hidden">
                    <div class="flex">
                        <!-- Left Sticky Labels (Enhanced Design & Fixed Heights) -->
                        <div class="flex flex-col border-r border-gray-200 min-w-[76px] items-stretch text-[10px] text-gray-500 font-bold bg-white z-10 shadow-lg relative">
                            <!-- Sickness Label (Height: 160px) -->
                            <div class="h-[160px] flex items-center justify-center w-full border-b border-gray-200 bg-gray-50/50">
                                <span class="-rotate-90 whitespace-nowrap text-xs tracking-widest text-gray-400">ä½“èª¿ LEVEL</span>
                            </div>
                            
                            <!-- Level Label (Height: h-6 / 24px) -->
                            <div class="h-6 w-full flex items-center justify-center bg-white border-b border-gray-100 border-r-4 border-r-teal-500 text-teal-600">Lv</div> 
                            
                            <!-- Weather Label Button (Height: h-11 / 44px) -->
                            <button onclick="toggleFilterCategory('weather')" class="h-11 w-full flex items-center justify-center border-b border-gray-100 bg-blue-50/50 hover:bg-blue-100 transition row-header-btn ${isWeatherActive} text-gray-600 relative">
                                å¤©æ°— <i class="fa-solid fa-filter text-[8px] ml-1 opacity-50"></i>
                            </button>

                            <!-- Transport Label Button (Height: h-11 / 44px) -->
                            <button onclick="toggleFilterCategory('transport')" class="h-11 w-full flex items-center justify-center border-b border-gray-100 hover:bg-gray-100 transition row-header-btn ${isTransportActive} text-gray-600 relative">
                                ä¹—ã‚Šç‰© <i class="fa-solid fa-filter text-[8px] ml-1 opacity-50"></i>
                            </button>

                            <!-- Date Label (Height: h-10 / 40px) -->
                            <div class="h-10 w-full flex items-center justify-center bg-gray-50 text-gray-400">æ—¥æ™‚</div>
                        </div>

                        <!-- Scrollable Content -->
                        <div class="overflow-x-auto flex-1 bg-white">
                            <div class="flex w-max">
                                ${chartItems}
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="flex justify-between items-center mt-3 px-2">
                    <div class="flex gap-3">
                        <p class="text-[10px] text-gray-400 flex items-center gap-1">
                            <span class="w-4 h-4 bg-gray-800 rounded-full flex items-center justify-center border border-white text-white text-[8px]"><i class="fa-solid fa-play"></i></span>
                            å‹•ç”»
                        </p>
                        <p class="text-[10px] text-gray-400 flex items-center gap-1">
                            <i class="fa-solid fa-comment-dots text-indigo-400 text-sm"></i>
                            ãƒ¡ãƒ¢
                        </p>
                    </div>
                    <p class="text-[10px] text-gray-400">ã‚°ãƒ©ãƒ•ã‚’ã‚¿ãƒƒãƒ—ã§è©³ç´°</p>
                </div>
            </div>
        `;
    }

    // --- Modal Logic ---
    window.showDetail = function(id) {
        const rec = records.find(r => r.id === id);
        if(!rec) return;

        // Populate Modal
        const dateObj = new Date(rec.date);
        document.getElementById('modal-date').innerText = `${dateObj.getMonth()+1}/${dateObj.getDate()} ${dateObj.getHours()}:${String(dateObj.getMinutes()).padStart(2, '0')}`;
        
        // Weather Icon
        const weatherIcons = { sunny: 'fa-sun text-orange-400', rain: 'fa-cloud-rain text-blue-500', cloudy: 'fa-cloud text-gray-400', unknown: 'fa-question text-gray-300' };
        const wClass = weatherIcons[rec.weather] || weatherIcons.unknown;
        document.getElementById('modal-weather').innerHTML = `<i class="fa-solid ${wClass}"></i>`;

        // Sickness
        document.getElementById('modal-sickness').innerText = `Lv.${rec.sickness}`;
        let emoji = 'ğŸ™‚';
        let colorClass = "text-2xl font-bold text-teal-600";
        if(rec.sickness >= 40) { emoji = 'ğŸ˜'; colorClass = "text-2xl font-bold text-yellow-500"; }
        if(rec.sickness >= 60) { emoji = 'ğŸ˜°'; colorClass = "text-2xl font-bold text-orange-500"; }
        if(rec.sickness >= 80) { emoji = 'ğŸ¤¢'; colorClass = "text-2xl font-bold text-red-600"; }
        document.getElementById('modal-emoji').innerText = emoji;
        document.getElementById('modal-sickness').className = colorClass;

        // Note
        document.getElementById('modal-note').innerText = rec.note || "ãƒ¡ãƒ¢ã¯ã‚ã‚Šã¾ã›ã‚“";

        // Video
        const videoSection = document.getElementById('modal-video-section');
        if(rec.hasVideo) {
            videoSection.classList.remove('hidden');
        } else {
            videoSection.classList.add('hidden');
        }

        // Show Modal
        document.getElementById('detail-modal').classList.remove('hidden');
    }

    window.closeDetail = function() {
        document.getElementById('detail-modal').classList.add('hidden');
    }

    // --- Filter Logic ---
    window.toggleFilterCategory = function(category) {
        if (filterState.category === category) {
            filterState = { category: null, value: null };
        } else {
            filterState.category = category;
            filterState.value = null; 
        }
        renderHistory(document.getElementById('content'));
    }

    window.setFilterValue = function(val) {
        if (filterState.value === val) {
             filterState.value = null;
        } else {
             filterState.value = val;
        }
        renderHistory(document.getElementById('content'));
    }

    window.clearFilter = function() {
        filterState = { category: null, value: null };
        renderHistory(document.getElementById('content'));
    }

    // --- Helpers & Handlers ---
    let currentVideoFile = null;

    window.handleVideoPreview = function(input) {
        const file = input.files[0];
        if (file) {
            currentVideoFile = file;
            const videoUrl = URL.createObjectURL(file);
            const preview = document.getElementById('video-preview');
            const container = document.getElementById('video-preview-container');
            const placeholder = document.getElementById('video-placeholder');
            
            preview.src = videoUrl;
            container.classList.remove('hidden');
            placeholder.classList.add('hidden');
        }
    }

    window.clearVideo = function() {
        currentVideoFile = null;
        document.getElementById('input-video').value = '';
        document.getElementById('video-preview').src = '';
        document.getElementById('video-preview-container').classList.add('hidden');
        document.getElementById('video-placeholder').classList.remove('hidden');
    }

    window.updateRangeDisplay = function(val) {
        const numVal = parseInt(val);
        let emoji = 'ğŸ™‚';
        let colorClass = "font-bold text-teal-600 text-3xl";

        if (numVal <= 30) {
            emoji = 'ğŸ™‚';
            colorClass = "font-bold text-teal-600 text-3xl";
        } else if (numVal <= 50) {
            emoji = 'ğŸ˜';
            colorClass = "font-bold text-teal-700 text-3xl";
        } else if (numVal <= 70) {
            emoji = 'ğŸ˜°';
            colorClass = "font-bold text-yellow-500 text-3xl";
        } else if (numVal <= 90) {
            emoji = 'ğŸ¤¢';
            colorClass = "font-bold text-orange-500 text-3xl";
        } else {
            emoji = 'ğŸ¤®';
            colorClass = "font-bold text-red-600 text-3xl";
        }

        document.getElementById('emoji-display').innerText = emoji;
        document.getElementById('level-display').innerText = `${numVal}`;
        document.getElementById('level-display').className = colorClass;
    }

    window.fetchWeatherMock = function() {
        const iconEl = document.getElementById('weather-icon');
        const textEl = document.getElementById('weather-text');
        const detailEl = document.getElementById('weather-detail');
        const inputEl = document.getElementById('input-weather');
        
        setTimeout(() => {
            const weathers = ['sunny', 'rain', 'cloudy'];
            const w = weathers[Math.floor(Math.random() * weathers.length)];
            
            const data = { 
                sunny: { label: 'æ™´ã‚Œ', temp: '24â„ƒ', press: '1013hPa', icon: 'fa-sun', color: 'text-orange-400' },
                rain: { label: 'é›¨', temp: '19â„ƒ', press: '998hPa', icon: 'fa-cloud-rain', color: 'text-blue-500' },
                cloudy: { label: 'æ›‡ã‚Š', temp: '21â„ƒ', press: '1005hPa', icon: 'fa-cloud', color: 'text-gray-400' }
            };
            const current = data[w];

            if(iconEl) {
                iconEl.innerHTML = `<i class="fa-solid ${current.icon}"></i>`;
                iconEl.className = `w-10 h-10 rounded-full bg-white flex items-center justify-center shadow-sm ${current.color}`;
                textEl.innerText = current.label;
                detailEl.innerText = `${current.temp} / ${current.press}`;
            }
            if(inputEl) inputEl.value = w;
        }, 800);
    }

    window.saveRecord = function(e) {
        e.preventDefault();
        
        const date = document.getElementById('input-date').value;
        const type = document.querySelector('input[name="transport"]:checked').value;
        const sickness = document.getElementById('input-sickness').value;
        const weather = document.getElementById('input-weather').value;
        const note = document.getElementById('input-note').value;
        const hasVideo = currentVideoFile !== null;

        lastTransport = type;
        localStorage.setItem('sukkiri_last_transport', type);

        const newRecord = {
            id: Date.now(),
            date,
            type,
            sickness: parseInt(sickness),
            weather,
            note,
            hasVideo 
        };

        records.push(newRecord);
        localStorage.setItem('sukkiri_records_v3', JSON.stringify(records));
        currentVideoFile = null;

        alert('è¨˜éŒ²ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼');
        navigateTo('history');
    }
    
    window.resetData = function() {
        if(confirm("ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ")) {
            localStorage.removeItem('sukkiri_records_v3');
            localStorage.removeItem('sukkiri_last_transport');
            location.reload();
        }
    }

    navigateTo('home');

</script>
</body>
</html>
